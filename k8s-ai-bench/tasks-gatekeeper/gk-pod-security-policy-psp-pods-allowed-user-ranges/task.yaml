cleanup: cleanup.sh
difficulty: medium
expect:
- contains: (?i)nginx-users-disallowed
- contains: (?i)nginx-users-disallowed-2
script:
- prompt: |
    You are reviewing Kubernetes resources for policy compliance.

    ## Policy Rule
    Controls the user and group IDs of the container and some volumes. Corresponds to the `runAsUser`, `runAsGroup`, `supplementalGroups`, and `fsGroup` fields in a PodSecurityPolicy. For more information, see https://kubernetes.io/docs/concepts/policy/pod-security-policy/#users-and-groups

    ## Policy Parameters
    ```yaml
    fsGroup:
      ranges:
      - max: 200
        min: 100
      rule: MustRunAs
    runAsGroup:
      ranges:
      - max: 200
        min: 100
      rule: MustRunAs
    runAsUser:
      ranges:
      - max: 200
        min: 100
      rule: MustRunAs
    supplementalGroups:
      ranges:
      - max: 200
        min: 100
      rule: MustRunAs
    ```

    ## Applicable Resource Types
    This policy applies to: Pod

    ## Resources to Review
    Below are the Kubernetes resource definitions to analyze:

    ```yaml
    apiVersion: v1
    kind: Pod
    metadata:
      name: nginx-users-allowed
      labels:
        app: nginx-users
    spec:
      securityContext:
        supplementalGroups:
          - 199
        fsGroup: 199
      containers:
        - name: nginx
          image: nginx
          securityContext:
            runAsUser: 199
            runAsGroup: 199
    ---
    apiVersion: v1
    kind: Pod
    metadata:
      name: nginx-users-disallowed
      labels:
        app: nginx-users
    spec:
      securityContext:
        supplementalGroups:
          - 250
        fsGroup: 250
      ephemeralContainers:
        - name: nginx
          image: nginx
          securityContext:
            runAsUser: 250
            runAsGroup: 250
    ---
    apiVersion: v1
    kind: Pod
    metadata:
      labels:
        app: nginx-users
      name: nginx-users-disallowed-2
    spec:
      containers:
      - image: nginx
        name: nginx
        securityContext:
          runAsGroup: 250
          runAsUser: 250
      securityContext:
        fsGroup: 250
        supplementalGroups:
        - 250

    ```

    ## Task
    Review the resources above and identify which ones violate the policy.

    List each violating resource in the format: `Kind/Name` with a brief explanation of why it violates the policy.
    If a resource is compliant, you do not need to list it.
setup: setup.sh
