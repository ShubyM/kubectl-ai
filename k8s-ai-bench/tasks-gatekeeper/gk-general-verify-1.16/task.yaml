cleanup: cleanup.sh
difficulty: medium
expect:
- contains: (?i)disallowed-deployment
script:
- prompt: |
    You are reviewing Kubernetes resources for policy compliance.

    ## Policy Rule
    Verifies deprecated Kubernetes APIs to ensure all the API versions are up to date. This template does not apply to audit as audit looks at the resources which are already present in the cluster with non-deprecated API versions.

    ## Policy Parameters
    ```yaml
    k8sVersion: 1.16
    kvs:
    - deprecatedAPI: apps/v1beta1
      kinds:
      - Deployment
      - ReplicaSet
      - StatefulSet
      targetAPI: apps/v1
    - deprecatedAPI: extensions/v1beta1
      kinds:
      - ReplicaSet
      - Deployment
      - DaemonSet
      targetAPI: apps/v1
    - deprecatedAPI: extensions/v1beta1
      kinds:
      - PodSecurityPolicy
      targetAPI: policy/v1beta1
    - deprecatedAPI: apps/v1beta2
      kinds:
      - ReplicaSet
      - StatefulSet
      - Deployment
      - DaemonSet
      targetAPI: apps/v1
    - deprecatedAPI: extensions/v1beta1
      kinds:
      - NetworkPolicy
      targetAPI: networking.k8s.io/v1
    ```

    ## Applicable Resource Types
    This policy applies to: Deployment, ReplicaSet, StatefulSet, DaemonSet, PodSecurityPolicy, ReplicaSet, Deployment, DaemonSet, NetworkPolicy

    ## Resources to Review
    Below are the Kubernetes resource definitions to analyze:

    ```yaml
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: allowed-deployment
      labels:
        app: nginx
    spec:
      replicas: 3
      selector:
        matchLabels:
          app: nginx
      template:
        metadata:
          labels:
            app: nginx
        spec:
          containers:
          - name: nginx
            image: nginx:1.14.2
            ports:
            - containerPort: 80
    ---
    apiVersion: apps/v1beta1
    kind: Deployment
    metadata:
      name: disallowed-deployment
      labels:
        app: nginx
    spec:
      replicas: 3
      selector:
        matchLabels:
          app: nginx
      template:
        metadata:
          labels:
            app: nginx
        spec:
          containers:
          - name: nginx
            image: nginx:1.14.2
            ports:
            - containerPort: 80
    ```

    ## Task
    Review the resources above and identify which ones violate the policy.

    List each violating resource in the format: `Kind/Name` with a brief explanation of why it violates the policy.
    If a resource is compliant, you do not need to list it.
setup: setup.sh
