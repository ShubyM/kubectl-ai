cleanup: cleanup.sh
difficulty: medium
expect:
- contains: (?i)nginx-disallowed
- contains: (?i)nginx-disallowed-2
- contains: (?i)nginx-disallowed-3
- contains: (?i)image-disallowed
- contains: (?i)nginx-disallowed-4
- contains: (?i)registry-repository-disallowed
script:
- prompt: |
    You are reviewing Kubernetes resources for policy compliance.

    ## Policy Rule
    This policy enforces that container images must begin with a string from a specified list. The updated version, K8sAllowedReposv2, introduces support for exact match and glob-like syntax to enhance security: 1. Exact Match: By default, if the * character is not specified, the policy strictly checks for an exact match of the full registry, repository, and/or the image name. 2. Glob-like Syntax: Adding * at the end of a prefix allows prefix-based matching (e.g., registry.example.com/project/*). Only the * wildcard at the end of a string is supported. 3. Security Note: To avoid bypasses scenarios, ensure prefixes include a trailing / where appropriate (e.g., registry.example.com/project/*).

    ## Policy Parameters
    ```yaml
    allowedImages:
    - openpolicyagent/*
    - myregistry.azurecr.io/*
    - mydockerhub/*
    - ubuntu:20.14
    - 123456789123.dkr.ecr.eu-west-1.amazonaws.com/postgres
    ```

    ## Applicable Resource Types
    This policy applies to: Pod

    ## Resources to Review
    Below are the Kubernetes resource definitions to analyze:

    ```yaml
    apiVersion: v1
    kind: Pod
    metadata:
      name: opa-allowed
    spec:
      containers:
        - name: opa
          image: openpolicyagent/opa:0.9.2
          args:
            - "run"
            - "--server"
            - "--addr=localhost:8080"
          resources:
            limits:
              cpu: "100m"
              memory: "30Mi"
    ---
    apiVersion: v1
    kind: Pod
    metadata:
      name: opa-allowed-2
    spec:
      containers:
      - image: ubuntu:20.14
        name: image
        resources:
          limits:
            cpu: 100m
            memory: 30Mi

    ---
    apiVersion: v1
    kind: Pod
    metadata:
      name: nginx-disallowed
    spec:
      initContainers:
      - name: nginx
        image: nginx
        resources:
          limits:
            cpu: "100m"
            memory: "30Mi"
      containers:
        - name: nginx
          image: nginx
          resources:
            limits:
              cpu: "100m"
              memory: "30Mi"
      ephemeralContainers:
        - name: nginx
          image: nginx
          resources:
            limits:
              cpu: "100m"
              memory: "30Mi"
    ---
    apiVersion: v1
    kind: Pod
    metadata:
      name: nginx-disallowed-2
    spec:
      containers:
      - image: nginx
        name: nginx
        resources:
          limits:
            cpu: 100m
            memory: 30Mi
      initContainers:
      - image: nginx
        name: nginxinit
        resources:
          limits:
            cpu: 100m
            memory: 30Mi

    ---
    apiVersion: v1
    kind: Pod
    metadata:
      name: nginx-disallowed-3
    spec:
      containers:
      - image: nginx
        name: nginx
        resources:
          limits:
            cpu: 100m
            memory: 30Mi

    ---
    apiVersion: v1
    kind: Pod
    metadata:
      name: image-disallowed
    spec:
      containers:
        - name: image-1-malicious-basic-image-disallow
          image: ubuntumalicious
          resources:
            limits:
              cpu: "100m"
              memory: "30Mi"
        - name: image-2-basic-image-allow
          image: ubuntu:20.14
          resources:
            limits:
              cpu: "200m"
              memory: "50Mi"
        - name: image-3-malicious-image-with-registry-disallow
          image: 123456789123.dkr.ecr.eu-west-1.amazonaws.com/postgresmalicious
          resources:
            limits:
              cpu: "50m"
              memory: "10Mi"
        - name: image-4-image-with-registry-allow
          image: 123456789123.dkr.ecr.eu-west-1.amazonaws.com/postgres
          resources:
            limits:
              cpu: "50m"
              memory: "10Mi"
    ---
    apiVersion: v1
    kind: Pod
    metadata:
      name: nginx-disallowed-4
    spec:
      containers:
      - args:
        - run
        - --server
        - --addr=localhost:8080
        image: openpolicyagent/opa:0.9.2
        name: opa
        resources:
          limits:
            cpu: 100m
            memory: 30Mi
      initContainers:
      - image: nginx
        name: nginxinit
        resources:
          limits:
            cpu: 100m
            memory: 30Mi

    ---
    apiVersion: v1
    kind: Pod
    metadata:
      name: registry-repository-disallowed
    spec:
      containers:
        - name: image-1-malicious-registry-disallow
          image: myregistry.azurecr.io.malicious.com/malicious-image
          resources:
            limits:
              cpu: "100m"
              memory: "30Mi"
        - name: image-2-registry-allow
          image: myregistry.azurecr.io/nginx
          resources:
            limits:
              cpu: "200m"
              memory: "50Mi"
        - name: image-3-malicious-image-with-registry-disallow
          image: mydockerhubmalicious/python
          resources:
            limits:
              cpu: "50m"
              memory: "10Mi"
        - name: image-4-image-with-registry-allow
          image: mydockerhub/python
          resources:
            limits:
              cpu: "50m"
              memory: "10Mi"
    ```

    ## Task
    Review the resources above and identify which ones violate the policy.

    List each violating resource in the format: `Kind/Name` with a brief explanation of why it violates the policy.
    If a resource is compliant, you do not need to list it.
setup: setup.sh
