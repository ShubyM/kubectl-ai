cleanup: cleanup.sh
difficulty: medium
expect:
- contains: (?i)disallowed-flowcontrol
script:
- prompt: |
    You are reviewing Kubernetes resources for policy compliance.

    ## Policy Rule
    Verifies deprecated Kubernetes APIs to ensure all the API versions are up to date. This template does not apply to audit as audit looks at the resources which are already present in the cluster with non-deprecated API versions.

    ## Policy Parameters
    ```yaml
    k8sVersion: 1.26
    kvs:
    - deprecatedAPI: flowcontrol.apiserver.k8s.io/v1beta1
      kinds:
      - FlowSchema
      - PriorityLevelConfiguration
      targetAPI: flowcontrol.apiserver.k8s.io/v1beta3
    - deprecatedAPI: autoscaling/v2beta2
      kinds:
      - HorizontalPodAutoscaler
      targetAPI: autoscaling/v2
    ```

    ## Applicable Resource Types
    This policy applies to: FlowSchema, PriorityLevelConfiguration, HorizontalPodAutoscaler

    ## Resources to Review
    Below are the Kubernetes resource definitions to analyze:

    ```yaml
    apiVersion: flowcontrol.apiserver.k8s.io/v1beta3
    kind: FlowSchema
    metadata:
      name: allowed-flowcontrol
      namespace: default
    spec:
      matchingPrecedence: 1000
      priorityLevelConfiguration:
        name: exempt
      rules:
        - nonResourceRules:
          - nonResourceURLs:
              - "/healthz"
              - "/livez"
              - "/readyz"
            verbs:
              - "*"
          subjects:
            - kind: Group
              group:
                name: "system:unauthenticated"
    ---
    apiVersion: flowcontrol.apiserver.k8s.io/v1beta1
    kind: FlowSchema
    metadata:
      name: disallowed-flowcontrol
      namespace: default
    spec:
      matchingPrecedence: 1000
      priorityLevelConfiguration:
        name: exempt
      rules:
        - nonResourceRules:
          - nonResourceURLs:
              - "/healthz"
              - "/livez"
              - "/readyz"
            verbs:
              - "*"
          subjects:
            - kind: Group
              group:
                name: "system:unauthenticated"
    ```

    ## Task
    Review the resources above and identify which ones violate the policy.

    List each violating resource in the format: `Kind/Name` with a brief explanation of why it violates the policy.
    If a resource is compliant, you do not need to list it.
setup: setup.sh
